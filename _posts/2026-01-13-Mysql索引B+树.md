---
layout:     post
title:      Mysql B+树索引
subtitle:   mysql
date:       2026-01-13
author:     toan
catalog:	true
tags:
    - B+树

---

## 问题

### 删除数据，查询会变快吗

`review`代码的时候，发现有删除数据插入到备份表，用来缓解主表查询压力的操作，但是删除之后没有重建表

这种操作是有问题的

1. 删除操作对B+树索引没有效果，虽然删除了，但是树占用的位置还在，删除太多之后，叶子节点无效数据占比超过90%
2. 查询速度也不会有量级的变化，甚至有可能更慢【数据碎片太多】

需要重建表，让索引树重建

### 非自增的唯一索引有问题吗

有一个表的唯一所以，不是自增id，是随机字符串，会有什么问题

1. 非自增id，频繁写，引起叶分裂的可能性更大，造成写放大

#### B+树特性

1. 所有叶子节点的高度都一样【高度增加，必须是由底向上，最后是`root`节点发生变化】

#### 叶分裂

什么是叶分裂：B+树索引，节点大小是16KB，当占用超过80%之后，再次进行插入，很容易进行分裂

随机插入和顺序插入都会有叶分裂，但是有一些区别【节点快写满才会分裂】

|          | 随机插入                                                     | 顺序插入                                                     |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 分裂位置 | 树中间                                                       | 最右                                                         |
| 页利用率 | 低【50%，因为分裂后会平均分配数据到两个页】                  | 很高                                                         |
| 树稳定性 | 低<br>插入位置遍布全树<br>分裂发生在任意节点<br>父节点可能经常被改变 | 高<br>插入位置高度集中（最右叶子）<br>分裂只会发生在最右叶子和父节点<br>绝大部分结构长期不动 |
| 写放大   | 高<br>写一条新数据<br>因为写入发生在中间，大概率会导致页分裂 | 低<br>大多数情况只需要写一条数据<br>如果分裂，写一个右叶子节点，更新父节点 |

### 索引顺序插入

不可能做到所有索引都顺序插入

1. 主建必须顺序插入
2. 频繁写入的尽量做到顺序插入【否则频繁页分裂导致的写放大会影响写入效率】
3. 尽可能覆盖索引，避免回表
